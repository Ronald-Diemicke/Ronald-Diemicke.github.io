---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPostBySlug, getPostsSortedByDate } from '../../data/posts';

export function getStaticPaths() {
  const posts = getPostsSortedByDate();
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = slug ? getPostBySlug(slug) : undefined;

if (!post) {
  return Astro.redirect('/');
}

const baseUrl = Astro.site ?? 'https://example.com';
const canonicalUrl = new URL(`/blog/${post.slug}`, baseUrl).href;
const publishedTime = new Date(post.date).toISOString();

const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  '@id': `${baseUrl}#organization`,
  name: 'Loki',
  url: baseUrl,
};

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.title,
  description: post.excerpt,
  datePublished: publishedTime,
  author: {
    '@type': 'Person',
    name: post.author,
  },
  publisher: { '@id': `${baseUrl}#organization` },
  url: canonicalUrl,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl,
  },
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: baseUrl },
    { '@type': 'ListItem', position: 2, name: post.title, item: canonicalUrl },
  ],
};

const structuredData = [organizationSchema, articleSchema, breadcrumbSchema];
---

<BaseLayout
  title={`${post.title} · Loki`}
  description={post.excerpt}
  type="article"
  publishedTime={publishedTime}
  author={post.author}
  structuredData={structuredData}
>
  <div class="blog-wrap">
    <header class="blog-header">
      <h1 class="blog-title"><a href="/">Loki</a></h1>
      <nav class="blog-nav" aria-label="Main">
        <a href="/">Home</a>
        <a href="/about">About me</a>
        <a href="/resources">Resources</a>
        <a href="/">Archive</a>
      </nav>
    </header>

    <main class="blog-main">
      <article class="blog-article">
        <a href="/" class="blog-back">&larr; Back to posts</a>

        <header class="blog-article-header">
          <time class="blog-article-date" datetime={post.date}>
            {new Date(post.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}
          </time>
          <h1 class="blog-article-title">{post.title}</h1>
          <p class="blog-article-meta">
            {post.author} · {post.readTimeMinutes} min read
          </p>
        </header>

        <div class="blog-article-body">
          {post.content.map((paragraph) => (
            <p>{paragraph}</p>
          ))}
        </div>

        <footer class="blog-article-footer">
          <a href="/" class="blog-back-link">&larr; Back to all posts</a>
        </footer>
      </article>
    </main>

    <footer class="blog-footer">
      <p style="margin: 0;">© {new Date().getFullYear()} Loki. Built with Astro and web components.</p>
    </footer>
  </div>
</BaseLayout>
